generator client {
  provider = "prisma-client-js"
  output   = "../../src/prisma-sqlite-client"
}

datasource db {
  provider = "sqlite"
  url      = env("TEST_DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  passwordHash String
  name      String?  // Conservé pour rétrocompatibilité
  coachName String   // Nom de coach (obligatoire)
  firstName String?  // Prénom (optionnel)
  lastName  String?  // Nom (optionnel)
  dateOfBirth DateTime? // Date de naissance (optionnel)
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  matches   Match[]
  createdMatches Match[] @relation("MatchCreator")
  teams     Team[]
  teamSelections TeamSelection[]
  createdCups Cup[] @relation("CupCreator")
}

model Match {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  status    String
  seed      String
  creator    User?   @relation("MatchCreator", fields: [creatorId], references: [id])
  creatorId  String?
  players   User[]
  turns     Turn[]
  teamSelections TeamSelection[]
}

model Turn {
  id        String   @id @default(cuid())
  match     Match    @relation(fields: [matchId], references: [id])
  matchId   String
  number    Int
  payload   Json
  createdAt DateTime @default(now())
}

model TeamSelection {
  id        String   @id @default(cuid())
  match     Match    @relation(fields: [matchId], references: [id])
  matchId   String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  team      String?
  teamRef   Team?    @relation(fields: [teamId], references: [id])
  teamId    String?
  createdAt DateTime @default(now())

  @@unique([matchId, userId])
  @@unique([matchId, teamId])
}

model Team {
  id        String   @id @default(cuid())
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  name      String
  roster    String
  createdAt DateTime @default(now())
  players   TeamPlayer[]
  selections TeamSelection[]
  cupParticipants CupParticipant[]
  
  // Informations d'équipe Blood Bowl
  treasury      Int @default(0)        // Trésorerie en pièces d'or (calculée automatiquement)
  rerolls       Int @default(0)        // Nombre de relances (0-8)
  cheerleaders  Int @default(0)        // Nombre de cheerleaders (0-12)
  assistants    Int @default(0)        // Nombre d'assistants (0-6)
  apothecary    Boolean @default(false) // Présence d'un apothicaire
  dedicatedFans Int @default(1)        // Nombre de fans dévoués (1-6)

  // Valeurs calculées automatiquement selon les règles Blood Bowl
  teamValue     Int @default(0)        // VE - Valeur d'Équipe (calculée)
  currentValue  Int @default(0)        // VEA - Valeur d'Équipe Actuelle (calculée)
  initialBudget Int @default(0)        // Budget initial saisi par l'utilisateur lors de la création
}

model TeamPlayer {
  id        String   @id @default(cuid())
  team      Team     @relation(fields: [teamId], references: [id])
  teamId    String
  name      String
  position  String
  number    Int
  ma        Int
  st        Int
  ag        Int
  pa        Int
  av        Int
  skills    String
}

// Modèle pour les coupes (tournois)
model Cup {
  id        String   @id @default(cuid())
  name      String   // Nom de la coupe (obligatoire)
  creator   User     @relation("CupCreator", fields: [creatorId], references: [id])
  creatorId String
  validated Boolean  @default(false) // Si true, la coupe est validée et fermée aux inscriptions
  isPublic  Boolean  @default(true)  // Si true, la coupe est publique et apparaît dans la liste
  status    String   @default("ouverte") // Statut: "ouverte", "en_cours", "terminee", "archivee"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  participants CupParticipant[]
  
  @@index([creatorId])
  @@index([validated])
  @@index([isPublic])
  @@index([status])
}

// Relation many-to-many entre Cup et Team (participants)
model CupParticipant {
  id        String   @id @default(cuid())
  cup       Cup      @relation(fields: [cupId], references: [id], onDelete: Cascade)
  cupId     String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId    String
  createdAt DateTime @default(now())
  
  @@unique([cupId, teamId])
  @@index([cupId])
  @@index([teamId])
}


