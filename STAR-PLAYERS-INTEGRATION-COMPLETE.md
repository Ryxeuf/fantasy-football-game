# Int√©gration des Star Players : Cr√©ation et Modification d'√âquipes

## üéØ Objectif

Int√©grer compl√®tement les Star Players dans le processus de cr√©ation et modification d'√©quipes, permettant de recruter des Star Players directement lors de la cr√©ation d'une √©quipe en respectant toutes les r√®gles de Blood Bowl.

## ‚úÖ Travail R√©alis√©

### 1. Modification des Endpoints de Cr√©ation d'√âquipes

#### `POST /team/create-from-roster`

**Avant :** Cr√©ait une √©quipe √† partir d'un template sans possibilit√© d'ajouter des Star Players.

**Apr√®s :** Accepte un tableau optionnel `starPlayers` contenant les slugs des Star Players √† recruter.

**Nouveaux param√®tres :**
```typescript
{
  name: string;
  roster: AllowedRoster;
  teamValue?: number;
  starPlayers?: string[];  // ‚ú® NOUVEAU
}
```

**Validations ajout√©es :**
- ‚úÖ V√©rification des paires obligatoires (Grak & Crumbleberry, Swift Twins)
- ‚úÖ V√©rification de la limite de 16 joueurs (joueurs + Star Players)
- ‚úÖ V√©rification du budget (co√ªt joueurs + co√ªt Star Players ‚â§ budget)
- ‚úÖ V√©rification de la disponibilit√© r√©gionale
- ‚úÖ V√©rification des doublons

**Exemple d'utilisation :**
```json
{
  "name": "Les Ratiers Fulgurants",
  "roster": "skaven",
  "teamValue": 1500,
  "starPlayers": ["hakflem_skuttlespike", "headsplitter"]
}
```

#### `POST /team/build`

**Avant :** Cr√©ait une √©quipe avec des joueurs personnalis√©s sans possibilit√© d'ajouter des Star Players.

**Apr√®s :** Accepte un tableau optionnel `starPlayers` avec les m√™mes validations que `/create-from-roster`.

**Nouveaux param√®tres :**
```typescript
{
  name: string;
  roster: AllowedRoster;
  teamValue?: number;
  choices: Array<{ key: string; count: number }>;
  starPlayers?: string[];  // ‚ú® NOUVEAU
}
```

**Nouvelle r√©ponse enrichie :**
```json
{
  "team": { ... },
  "cost": 1450,
  "budget": 1800,
  "breakdown": {         // ‚ú® NOUVEAU
    "players": 1280,
    "starPlayers": 170
  }
}
```

### 2. Validations et R√®gles Impl√©ment√©es

#### R√®gles de Blood Bowl Respect√©es

| R√®gle | Impl√©mentation | Statut |
|-------|----------------|--------|
| Maximum 16 joueurs | `currentPlayerCount + starPlayers.length ‚â§ 16` | ‚úÖ |
| Budget respect√© | `totalCost + starPlayersCost ‚â§ teamValue` | ‚úÖ |
| Paires obligatoires | `validateStarPlayerPairs()` | ‚úÖ |
| R√®gles r√©gionales | `validateStarPlayersForTeam()` | ‚úÖ |
| Pas de doublons | V√©rification dans validation | ‚úÖ |
| Co√ªts officiels | Donn√©es de `star-players.ts` | ‚úÖ |

#### Messages d'Erreur Explicites

```json
// Limite de joueurs d√©pass√©e
{
  "error": "Trop de joueurs ! 14 joueurs + 3 Star Players = 17 (maximum: 16)"
}

// Budget insuffisant
{
  "error": "Budget d√©pass√©: 1650k (1200k joueurs + 450k Star Players) / 1500k"
}

// Paire incompl√®te
{
  "error": "Grak et Crumbleberry doivent √™tre recrut√©s ensemble"
}

// Star Player indisponible
{
  "error": "Hakflem Skuttlespike n'est pas disponible pour cette √©quipe"
}
```

### 3. Fichiers Modifi√©s

#### `apps/server/src/routes/team.ts`

**Modifications principales :**

1. **Endpoint `/create-from-roster`** (lignes 304-475)
   - Ajout du param√®tre `starPlayers` optionnel
   - Validation des paires obligatoires
   - Validation de la limite de 16 joueurs
   - Validation du budget incluant les Star Players
   - Cr√©ation atomique des Star Players avec l'√©quipe
   - Enrichissement des donn√©es retourn√©es

2. **Endpoint `/build`** (lignes 477-647)
   - Ajout du param√®tre `starPlayers` optionnel
   - M√™mes validations que `/create-from-roster`
   - Calcul d√©taill√© du budget avec breakdown
   - Cr√©ation atomique des Star Players avec l'√©quipe

**Changements de code cl√©s :**

```typescript
// Validation des paires
const pairValidation = validateStarPlayerPairs(starPlayersToHire);
if (!pairValidation.valid) {
  return res.status(400).json({ error: pairValidation.error });
}

// Validation de la limite de 16 joueurs
if (totalPlayers + starPlayersToHire.length > 16) {
  return res.status(400).json({ 
    error: `Trop de joueurs ! ${totalPlayers} joueurs + ${starPlayersToHire.length} Star Players = ${totalPlayers + starPlayersToHire.length} (maximum: 16)` 
  });
}

// Validation du budget
const starPlayersCost = calculateStarPlayersCost(starPlayersToHire);
const validation = validateStarPlayersForTeam(
  starPlayersToHire,
  roster,
  totalPlayers,
  availableBudget
);

// Cr√©ation des Star Players
const starPlayersData = starPlayersToHire.map((slug: string) => {
  const sp = getStarPlayerBySlug(slug);
  return {
    teamId: team.id,
    starPlayerSlug: slug,
    cost: sp?.cost || 0
  };
});

await prisma.teamStarPlayer.createMany({ data: starPlayersData });
```

#### Imports utilis√©s

```typescript
import { getStarPlayerBySlug } from "@bb/game-engine";
import {
  validateStarPlayerHire,
  validateStarPlayerPairs,
  validateStarPlayersForTeam,
  getTeamAvailableStarPlayers,
  calculateStarPlayersCost,
  requiresPair,
} from "../utils/star-player-validation";
```

### 4. Documentation Cr√©√©e

#### `STAR-PLAYERS-TEAM-CREATION.md`

Documentation compl√®te couvrant :
- Utilisation des endpoints modifi√©s
- Exemples de requ√™tes et r√©ponses
- Description de toutes les validations
- Exemples d'erreurs
- Guide d'int√©gration frontend
- Composant React exemple

### 5. Tests Cr√©√©s

#### `test-create-team-with-star-players.js`

Script de test Node.js couvrant :
1. ‚úÖ Connexion utilisateur
2. ‚úÖ Cr√©ation d'√©quipe Skaven avec Hakflem (create-from-roster)
3. ‚úÖ Cr√©ation d'√©quipe Goblin avec paire Grak & Crumbleberry (build)
4. ‚úÖ Validation de paire incompl√®te (erreur attendue)
5. ‚úÖ Validation de d√©passement de budget (erreur attendue)
6. ‚úÖ Validation de limite de 16 joueurs (erreur attendue)
7. ‚úÖ Cr√©ation d'√©quipe Halfling avec Deeproot Strongbranch
8. ‚úÖ Validation de disponibilit√© r√©gionale (erreur attendue)

## üìä Flux de Cr√©ation d'√âquipe avec Star Players

```mermaid
graph TD
    A[Requ√™te de cr√©ation] --> B{Param√®tres valides?}
    B -->|Non| C[Erreur 400]
    B -->|Oui| D{Star Players fournis?}
    D -->|Non| E[Cr√©er √©quipe sans SP]
    D -->|Oui| F[Valider paires obligatoires]
    F -->|Invalide| C
    F -->|Valide| G[V√©rifier limite 16 joueurs]
    G -->|D√©pass√©| C
    G -->|OK| H[Calculer co√ªt total]
    H --> I{Budget suffisant?}
    I -->|Non| C
    I -->|Oui| J[Valider disponibilit√© r√©gionale]
    J -->|Invalide| C
    J -->|Valide| K[Transaction: Cr√©er √©quipe + joueurs + SP]
    K --> L[Enrichir donn√©es SP]
    L --> M[Retourner √©quipe compl√®te]
```

## üîß Utilisation Pratique

### Cas d'usage 1 : √âquipe Skaven avec 1 Star Player

```bash
curl -X POST http://localhost:3001/team/create-from-roster \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN" \
  -d '{
    "name": "Les Ratiers Fulgurants",
    "roster": "skaven",
    "teamValue": 1500,
    "starPlayers": ["hakflem_skuttlespike"]
  }'
```

**R√©sultat :**
- √âquipe cr√©√©e avec template Skaven (11-16 joueurs)
- Hakflem Skuttlespike recrut√© (180K po)
- Budget restant : 1500K - co√ªt_joueurs - 180K

### Cas d'usage 2 : √âquipe personnalis√©e avec paire

```bash
curl -X POST http://localhost:3001/team/build \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN" \
  -d '{
    "name": "Les Gobelins Farceurs",
    "roster": "goblin",
    "teamValue": 1500,
    "choices": [
      { "key": "goblin_lineman", "count": 10 },
      { "key": "goblin_pogoer", "count": 1 }
    ],
    "starPlayers": ["grak", "crumbleberry"]
  }'
```

**R√©sultat :**
- 10 Goblin Linemen + 1 Goblin Pogoer = 11 joueurs
- Grak (280K po) + Crumbleberry (0K po) = 2 Star Players
- Total : 13 joueurs (sous la limite de 16)
- Budget v√©rifi√© automatiquement

### Cas d'usage 3 : Validation automatique

```bash
# Cette requ√™te √©chouera avec une erreur explicite
curl -X POST http://localhost:3001/team/build \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN" \
  -d '{
    "name": "Test Invalide",
    "roster": "goblin",
    "teamValue": 1000,
    "choices": [{ "key": "goblin_lineman", "count": 11 }],
    "starPlayers": ["grak"]  # Manque crumbleberry
  }'
```

**Erreur retourn√©e :**
```json
{
  "error": "Grak et Crumbleberry doivent √™tre recrut√©s ensemble"
}
```

## üé® Int√©gration Frontend

### √âtat actuel

Les endpoints backend sont pr√™ts et fonctionnels. L'int√©gration frontend n√©cessite :

1. **Modification du formulaire de cr√©ation d'√©quipe**
   - Ajouter une section "Star Players Disponibles"
   - Afficher les Star Players selon le roster s√©lectionn√©
   - Calculer le budget en temps r√©el

2. **Utilisation de l'endpoint `/star-players/available/:roster`**
   ```typescript
   const response = await fetch(`/star-players/available/${roster}`);
   const { starPlayers } = await response.json();
   ```

3. **Gestion des paires obligatoires**
   - D√©tecter automatiquement les paires (Grak/Crumbleberry, Swift Twins)
   - Cocher/d√©cocher automatiquement le partenaire
   - Afficher un avertissement si paire incompl√®te

4. **Calcul du budget restant**
   ```typescript
   const starPlayersCost = selectedStarPlayers.reduce((sum, slug) => {
     const sp = availableStarPlayers.find(sp => sp.slug === slug);
     return sum + (sp?.cost || 0);
   }, 0);
   
   const remainingBudget = totalBudget - playersCost - starPlayersCost;
   ```

### Composant React minimal

Voir `STAR-PLAYERS-TEAM-CREATION.md` pour un exemple complet.

## üß™ Tests et Validation

### Tests √† ex√©cuter

```bash
# 1. D√©marrer le serveur
cd apps/server
npm run dev

# 2. Dans un autre terminal, lancer les tests
node test-create-team-with-star-players.js
```

### Sc√©narios de test couverts

| Sc√©nario | Endpoint | R√©sultat Attendu |
|----------|----------|------------------|
| Cr√©ation simple avec 1 SP | create-from-roster | ‚úÖ Succ√®s |
| Cr√©ation avec paire valide | build | ‚úÖ Succ√®s |
| Paire incompl√®te | build | ‚ùå Erreur 400 |
| Budget d√©pass√© | build | ‚ùå Erreur 400 |
| Limite 16 joueurs | build | ‚ùå Erreur 400 |
| SP non disponible pour roster | build | ‚ùå Erreur 400 |
| Doublons | build | ‚ùå Erreur 400 |

## üìà Am√©liorations Futures

### Court terme

- [ ] Ajouter des tests d'int√©gration automatis√©s (Vitest)
- [ ] Cr√©er l'interface frontend de s√©lection des Star Players
- [ ] Ajouter des logs pour le tracking des recrutements

### Moyen terme

- [ ] Impl√©menter le syst√®me de renvoi de Star Players
- [ ] G√©rer les limitations de certains Star Players (ex: une fois par saison)
- [ ] Historique des Star Players recrut√©s par √©quipe

### Long terme

- [ ] Statistiques des Star Players les plus populaires
- [ ] Syst√®me de recommandation de Star Players selon le roster
- [ ] Int√©gration avec le syst√®me de matchs (bonus, malus)

## üìù Checklist de D√©ploiement

- [x] Modifications backend impl√©ment√©es
- [x] Validations compl√®tes ajout√©es
- [x] Documentation cr√©√©e
- [x] Script de test cr√©√©
- [ ] Tests d'int√©gration ex√©cut√©s
- [ ] Interface frontend cr√©√©e
- [ ] Tests E2E frontend
- [ ] Review de code
- [ ] Migration base de donn√©es (d√©j√† faite)
- [ ] D√©ploiement en staging
- [ ] D√©ploiement en production

## üéâ R√©sum√©

### Ce qui fonctionne maintenant

‚úÖ Cr√©ation d'√©quipes avec Star Players en une seule requ√™te  
‚úÖ Validation automatique de toutes les r√®gles Blood Bowl  
‚úÖ Gestion automatique des paires obligatoires  
‚úÖ Calcul pr√©cis du budget incluant les Star Players  
‚úÖ Respect de la limite de 16 joueurs  
‚úÖ R√®gles r√©gionales appliqu√©es automatiquement  
‚úÖ Messages d'erreur clairs et explicites  
‚úÖ Donn√©es enrichies dans les r√©ponses API  

### Impact

- **Simplification** : Plus besoin de cr√©er l'√©quipe puis ajouter les Star Players s√©par√©ment
- **S√©curit√©** : Toutes les r√®gles sont valid√©es c√¥t√© serveur
- **UX** : Messages d'erreur clairs pour guider l'utilisateur
- **Performance** : Une seule transaction pour cr√©er l'√©quipe compl√®te
- **Maintenabilit√©** : Code centralis√© et r√©utilisable

### Prochaine √©tape

Int√©gration dans l'interface web pour permettre aux utilisateurs de :
1. Voir les Star Players disponibles selon leur roster
2. S√©lectionner des Star Players lors de la cr√©ation d'√©quipe
3. Voir le budget restant en temps r√©el
4. Recevoir des avertissements pour les paires obligatoires

## üìö R√©f√©rences

- `STAR-PLAYERS-TEAM-CREATION.md` : Documentation compl√®te de l'int√©gration
- `STAR-PLAYERS-README.md` : Vue d'ensemble du syst√®me de Star Players
- `STAR-PLAYERS-IMPLEMENTATION.md` : D√©tails techniques de l'impl√©mentation
- `apps/server/src/routes/team.ts` : Code source des endpoints
- `apps/server/src/utils/star-player-validation.ts` : Fonctions de validation
- `packages/game-engine/src/rosters/star-players.ts` : Donn√©es des Star Players

---

**Date de cr√©ation :** 24 octobre 2025  
**Version :** 1.0  
**Statut :** ‚úÖ Complet (Backend) - üîÑ En attente (Frontend)

